<html>
  <head>
    <script src="https://login.persona.org/authentication_api.js"></script>
  </head>
  <body>
    <script>
    navigator.id.beginAuthentication(function(email) {

    });
    function getAccessToken() {
      try {
        return location.href.match(/access_token=(\S*)&/)[1];
      }
      catch(err) {
        return null;
      }
    }

    var token = getAccessToken();

    function onLoadJSONP(j) {
      console.log(JSON.stringify(j));
      navigator.id.beginAuthentication(function(email) {
        if(j.email == email) {
          navigator.id.completeAuthentication();
        }
      });
    }

    if(token) {
      alert("got token! " + token);

      var script = document.createElement('script');
      script.src = 'https://graph.facebook.com/me?access_token=' + token + '&callback=onLoadJSONP';
      document.getElementsByTagName('head')[0].appendChild(script);
    }
    else {
      location.href="https://www.facebook.com/dialog/oauth?display=popup&response_type=token&scope=email&client_id=359821740813622&redirect_uri=https://ryanseys.com/browserid/sign_in.html?";
    }
    </script>
  </body>
</html>
